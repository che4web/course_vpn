= VPN
:icons: font


== StrongSwan

StrongSwan  -- это октрытая реализация стандатра ipsec. Данная реализация является рекомендованной в современных дистрибутивах. До этого была OpenSwan,LibreSwan, Raccon и некторые другие. 

Проект поддерживается Андреасом Штеффеном, почетным профессором безопасности в коммуникациях Университета прикладных наук в Рапперсвиле, Швейцария.

Как потомок проекта FreeS/WAN, strongSwan продолжает выпускаться под лицензией GPL.[2] Он поддерживает списки отозванных сертификатов и протокол состояния онлайн-сертификатов (OCSP). Уникальной особенностью является использование сертификатов атрибутов X.509 для реализации схем управления доступом на основе членства в группах. StrongSwan взаимодействует с другими реализациями IPsec, включая различные VPN-клиенты Microsoft Windows и macOS. Текущая версия strongSwan полностью реализует протокол Internet Key Exchange (IKEv2), определенный в RFC 7296.[3]



Internet Key Exchange (IKE)

*    Implements the IKEv2 (RFC 7296) key exchange protocol (IKEv1 is also supported)


*    Fully tested support of IPv6 IPsec tunnel and transport mode connections

*    Dynamic IP address and interface update with MOBIKE (RFC 4555)

*    Automatic insertion and deletion of IPsec-policy-based firewall rules

*    NAT-Traversal via UDP encapsulation and port floating (RFC 3947)

*    Support of IKEv2 message fragmentation (RFC 7383) to avoid issues with IP fragmentation

*    Dead Peer Detection (DPD, RFC 3706) takes care of dangling tunnels

*    Virtual IP address pool managed by IKE daemon, DHCP, RADIUS or SQL database

*    Implemented RFCs and Internet Drafts


== Описание сети

https://docs.strongswan.org/docs/5.9/howtos/introduction.html

* Gateway

     Шлюзом обычно является ваш брандмауэр, но это может быть любой хост в вашей сети. Часто шлюз также может обслуживать небольшую сеть с DHCP и DNS. На изображении выше узлы луны и солнца служат воротами для внутренних узлов alice, venus и bob соответственно.
Удаленный доступ/клиенты Roadwarrior

* Remote Access / Roadwarrior Clients 

     Обычно roadwarriors — это ноутбуки и другие мобильные устройства, удаленно подключающиеся к вашей домашней сети через шлюз. На изображении выше Кэрол и Дейв представляют дорожных воинов, которые хотят получить доступ к любой из двух сетей за двумя шлюзами.
Удаленные хосты/хост-хост

* Remote Hosts / Host-to-Host 

    Это может быть удаленный веб-сервер или система резервного копирования. Это проиллюстрировано на изображении хозяином Виннету и любыми вратами Луны и Солнца. Соединение между двумя хостами обычно может быть инициировано любым из них.
Удаленные сайты / сайт-сайт

* Remote Sites / Site-to-Site 

     Хосты в двух или более подсетях в разных местах должны иметь доступ друг к другу. Снова ссылаясь на изображение выше, две подсети 10.1.0.0/16 и 10.2.0.0/24 за шлюзами moon и sun соответственно могут быть соединены, так что, например. хосты Алиса и Боб могут безопасно общаться друг с другом.



== IKE and IPsec Basics
image::../img/topology.png[400,400]

strongSwan — это, по сути, демон ключей, который использует протокол обмена ключами в Интернете версии 2 (IKEv2) для установления ассоциаций безопасности (SA) между двумя одноранговыми узлами. Для устаревших приложений IKEv1 по-прежнему поддерживается, хотя мы настоятельно не рекомендуем использовать IKEv1 из-за стабильности и некоторых соображений безопасности. IKE обеспечивает строгую аутентификацию обоих одноранговых узлов и создает уникальные криптографически стойкие сеансовые ключи. Такой сеанс IKE часто обозначается в нашей документации как IKE_SA. Помимо аутентификации и ключевого материала, IKE также предоставляет средства для обмена информацией о конфигурации (например, виртуальными IP-адресами) и согласования сопоставлений безопасности IPsec, которые часто называют CHILD_SA. IPsec SA определяет, какой сетевой трафик должен быть защищен и как он должен быть зашифрован и аутентифицирован.

CHILD_SA состоит из двух компонентов:

* Фактические SA IPsec (установлены две, по одной в каждом направлении), описывающие алгоритмы и ключи, используемые для шифрования и аутентификации трафика.

* Политики (их как минимум две), которые определяют, какой сетевой трафик должен использовать эту SA.

Политики работают в обоих направлениях, т. е. после расшифровки будет разрешен только трафик, соответствующий входящей политике. Политики выводятся из селекторов трафика (TS), согласованных через IKE при установлении CHILD_SA. Незащищенный трафик, который получает ядро и для которого нет соответствующей политики IPsec для входящего трафика, будет отброшен. Это функция безопасности.

Фактический трафик IPsec не обрабатывается strongSwan, а передается в сеть и стек IPsec ядра операционной системы. strongSwan устанавливает согласованные SA и SP IPsec в ядро с помощью интерфейса ядра, зависящего от платформы.

Упомянутое различие между политиками и SA часто приводит к ошибочным представлениям. Например, на изображении выше, если хост Moon имеет туннель site-to-site для хоста sun (соединяющий две сети 10.1.0.0/16 и 10.2.0.0/24), а хост carol имеет соединение roadwarrior с хостом sun (от которого Кэрол получила виртуальный IP-адрес 10.3.0.10). Тогда Кэрол не сможет автоматически связываться с Алисой, даже если переадресация включена на Sun. Это связано с отсутствием политики IPsec, разрешающей трафик между Кэрол (10.3.0.10) и Алисой (10.1.0.10). Дополнительный SA между Moon и Sun, соединяющий виртуальную подсеть 10.3.0.0/24 с 10.1.0.0/16, был бы возможным решением этой проблемы.

Как правило, обработка и маршрутизация IPsec — это две разные темы. IPsec часто просто попадает в стек (на основе политики), и исходное решение о маршрутизации для незащищенного пакета также применяется к защищенному пакету. По этой причине демон IKE strongSwan charon по умолчанию устанавливает определенные маршруты к удаленной части TS (в более новых версиях charon (> 5.5.0) маршруты не устанавливаются для транспортных режимов CHILD_SA). Исключением является IPsec на основе маршрутов, который использует интерфейсы для управления тем, какие пакеты будут обрабатываться каждым туннелем для уникального участника. IPsec на основе маршрутов менее гибок, чем IPsec на основе политик.



== Authentication Basics

Чтобы гарантировать, что узел, с которым устанавливается IKE_SA, действительно является тем, за кого он себя выдает, он должен быть аутентифицирован.

strongSwan предоставляет несколько способов сделать это:

=== Аутентификация с открытым ключом
(Public Key Authentication )

Сертификаты RSA, ECDSA или EdDSA X.509 используются для проверки подлинности однорангового узла.

Сертификаты могут быть самоподписанными (в этом случае они должны быть установлены на всех одноранговых узлах) или подписаны общим центром сертификации (ЦС). Последнее значительно упрощает развертывание и настройку, поскольку шлюзу требуется только сертификат ЦС для аутентификации всех одноранговых узлов, которые предоставляют действительный сертификат, подписанный этим ЦС.

Списки отзыва сертификатов (CRL) или онлайн-протокол статуса сертификата (OCSP) могут использоваться для проверки действительности сертификатов.

Для безопасного хранения закрытых ключей можно использовать смарт-карты через плагин pkcs11.

Чтобы предотвратить атаки «человек посередине», личность, заявленная узлом, должна быть подтверждена сертификатом либо с помощью расширения subjectDn, либо с помощью расширения subjectAltName.

=== Аутентификация с предварительным общим ключом (PSK)

Предварительно общий ключ — это простой в развертывании вариант, но для его защиты требуются надежные секреты.

Если PSK известен многим пользователям (что часто бывает в IKEv1 XAuth с PSK), любой пользователь, знающий секрет, может выдать себя за шлюз. Поэтому этот метод не рекомендуется для крупномасштабных развертываний.

=== Расширяемый протокол аутентификации (EAP)

Это охватывает несколько возможных методов аутентификации, некоторые из которых основаны на аутентификации на основе имени пользователя и пароля (EAP-MD5, EAP-MSCHAPv2, EAP-GTC) или на сертификатах X.509 (EAP-TLS). Некоторые могут даже туннелировать другие методы EAP (EAP-TTLS, EAP-PEAP).

Фактическая аутентификация пользователей может быть делегирована серверу RADIUS с помощью плагина eap-radius.

Аутентификацию EAP можно использовать только с IKEv2 и для некоторых методов с IKEv1 с помощью подключаемого модуля xauth-eap.

=== Расширенная аутентификация (XAuth)

XAuth обеспечивает гибкую структуру аутентификации в IKEv1. Он в основном используется для аутентификации на основе имени пользователя/пароля. Кроме того, он обычно используется в качестве второго метода аутентификации после взаимной аутентификации на основе сертификатов X.509 или PSK. Однако при гибридной аутентификации IKEv1 можно аутентифицировать шлюз с помощью сертификата и использовать XAuth только для аутентификации клиента.

С IKEv2 можно использовать несколько раундов аутентификации (RFC 4739), например, сначала аутентифицировать машину с помощью сертификата X.509, а затем пользователя с помощью схемы аутентификации на основе имени пользователя и пароля (например, EAP-MSCHAPv2). Также можно использовать асимметричную аутентификацию, например. путем аутентификации шлюза с помощью сертификата и клиента с помощью метода EAP на основе имени пользователя и пароля в первом раунде аутентификации. Имейте в виду, что не все реализации IKEv2 поддерживают расширение RFC 4739.

==  Configuration Files

Рекомендуемый способ настройки strongSwan — через мощный интерфейс управления vici и инструмент командной строки swanctl. Файл конфигурации swanctl.conf, используемый swanctl, хранится вместе с сертификатами и соответствующими закрытыми ключами в каталоге swanctl.

Глобальные настройки strongSwan, а также конфигурации для конкретных плагинов определяются в strongswan.conf.

Кроме того, устаревший интерфейс управления ходом и инструмент командной строки ipsec можно использовать с устаревшими файлами конфигурации ipsec.conf и ipsec.secrets.
Другие источники конфигурации

Конфигурация также может быть загружена из базы данных SQL или может быть предоставлена с помощью пользовательских подключаемых модулей. Используя вариант демона charon-nm, NetworkManager можно использовать для управления VPN-подключениями.
